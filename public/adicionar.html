<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Movimento - Cardistry Dex</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="header">
        <a href="index.html" class="header-title">← Voltar ao Dex</a>
    </header>

    <main class="form-page">
        <h1>Adicionar Novo Movimento</h1>
        <p style="text-align: center; color: var(--text-color-secondary); margin-bottom: 1.5rem;">
            Sua submissão será revisada por um moderador antes de ser publicada.
        </p>

        <form id="add-move-form">
            <div class="form-group">
                <label for="move-name">Nome do Movimento</label>
                <input type="text" id="move-name" required>
                <div id="move-name-error" class="form-error">
                    ERRO: Este movimento já existe ou está pendente de aprovação.
                </div>
            </div>

            <div class="form-group">
                <label for="creator-name">Nome do Criador(es)</label>
                <input type="text" id="creator-name" required>
            </div>

            <div class="form-group">
                <label for="year">Ano de Criação (aprox.)</label>
                <input type="number" id="year" placeholder="Ex: 2015">
            </div>

            <div class="form-group">
                <label for="tags">Estilos / Tags (separados por vírgula)</label>
                <input type="text" id="tags" placeholder="Ex: Corte, Uma Mão, Aéreo">
            </div>

            <div class="form-group">
                <label for="demo-link">Link do Demo (YouTube ou Instagram)</label>
                <input type="url" id="demo-link" required placeholder="https://youtube.com/watch?v=...">
            </div>

            <div class="form-group">
                <label for="tutorial-link">Link do Tutorial (opcional)</label>
                <input type="url" id="tutorial-link" placeholder="https://youtube.com/watch?v=...">
            </div>

            <div class="form-group">
                <label for="description">História / Descrição</label>
                <textarea id="description" placeholder="Conte a história do movimento, como ele funciona..."></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" id="submit-button" class="btn" disabled>Enviar para Revisão</button>
            </div>
        </form>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-check-compat.js"></script>
    
    <script>
        // --- 1. CONFIGURAÇÃO DO FIREBASE (COLE A SUA AQUI) ---
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "cardistry-dex.firebaseapp.com",
            projectId: "cardistry-dex",
            storageBucket: "cardistry-dex.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. CONFIGURAÇÃO DO APP CHECK (COLE SUA CHAVE DO RECAPTCHA v3) ---
        const RECAPTCHA_SITE_KEY = '6LfZMvErAAAAAG1J21iqjlnLM3ZhDs10QmFEKcGa'; // Sua Chave de Site
        try {
            const appCheck = firebase.appCheck();
            appCheck.activate(
                new firebase.appCheck.ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),
                true
            );
        } catch (err) { console.error("Erro ao ativar o App Check:", err); }

        // --- 3. LÓGICA DO FORMULÁRIO ---
        const nameInput = document.getElementById('move-name');
        const errorDiv = document.getElementById('move-name-error');
        const submitButton = document.getElementById('submit-button');
        const form = document.getElementById('add-move-form');

        function normalizeText(text) {
            if (!text) return '';
            return text.trim().toLowerCase();
        }

        // 4. VERIFICAÇÃO DE DUPLICATAS (Quando o usuário sai do campo)
        nameInput.addEventListener('blur', async () => {
            const name = nameInput.value;
            const normalizedName = normalizeText(name);

            if (normalizedName === '') return;
            
            submitButton.disabled = true;
            errorDiv.style.display = 'none';

            try {
                const q1 = db.collection('moves_published').where('moveName_normalized', '==', normalizedName).limit(1);
                const q2 = db.collection('moves_pending').where('moveName_normalized', '==', normalizedName).limit(1);
                
                const [snapshot1, snapshot2] = await Promise.all([q1.get(), q2.get()]);

                if (!snapshot1.empty || !snapshot2.empty) {
                    errorDiv.style.display = 'block';
                    submitButton.disabled = true;
                } else {
                    errorDiv.style.display = 'none';
                    submitButton.disabled = false; // Nome é único, ativa o botão
                }
            } catch (err) {
                console.error("Erro ao verificar duplicata:", err);
                submitButton.disabled = true;
            }
        });
        
        // 5. ENVIO DO FORMULÁRIO
        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // Impede o envio normal do formulário
            submitButton.disabled = true;
            submitButton.innerText = 'Enviando...';

            try {
                const moveName = nameInput.value;
                const creatorName = document.getElementById('creator-name').value;
                const tagsRaw = document.getElementById('tags').value;
                
                // Transforma "Corte, Uma Mão" em ["corte", "uma mão"]
                const tagsArray = tagsRaw.split(',')
                                        .map(tag => tag.trim().toLowerCase())
                                        .filter(tag => tag.length > 0);

                await db.collection('moves_pending').add({
                    moveName: moveName,
                    moveName_normalized: normalizeText(moveName),
                    creatorName: creatorName,
                    year: document.getElementById('year').value || null,
                    tags: tagsArray,
                    demoLink: document.getElementById('demo-link').value,
                    tutorialLink: document.getElementById('tutorial-link').value || null,
                    description: document.getElementById('description').value,
                    submittedAt: new Date()
                });
                
                // Sucesso!
                alert('Movimento enviado para revisão! Obrigado por contribuir.');
                form.reset(); // Limpa o formulário

            } catch (err) {
                console.error("Erro ao enviar:", err);
                alert('Ops! Algo deu errado. Verifique sua conexão e tente novamente.');
            } finally {
                submitButton.disabled = true; // Desativa após enviar (precisa re-validar o nome)
                submitButton.innerText = 'Enviar para Revisão';
            }
        });

    </script>
</body>
</html>
